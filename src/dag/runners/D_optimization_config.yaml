# ------------------------------------------------------------
# Pipeline D â€” Hyperparameter Optimization Configuration
# ------------------------------------------------------------
# Purpose:
#   Controls hyperparameter search behavior for each ticker
#   using feature datasets generated by Pipeline C.
#
# Scope:
#   - No model artifacts are persisted
#   - Only metrics, params, and trial metadata are logged
# ------------------------------------------------------------

optimization:

  # ----------------------------------------------------------
  # Model
  # ----------------------------------------------------------
  model:
    type: lstm                # lstm | transformer | xgboost
    lookback: 20              # Default static lookback; can be overridden by search_space

  # ----------------------------------------------------------
  # Optimizer backend
  # ----------------------------------------------------------
  optimizer: optuna

  # ----------------------------------------------------------
  # Search budget
  # ----------------------------------------------------------
  n_trials: 50               # Total trials per ticker
  timeout_sec: null          # Optional wall-clock timeout per ticker

  # ----------------------------------------------------------
  # Optimization objective
  # ----------------------------------------------------------
  direction: minimize        # maximize | minimize
  primary_metric: rmse       # Must match evaluation metric key returned from objective

  # ----------------------------------------------------------
  # Sampler & pruner (Optuna-native)
  # ----------------------------------------------------------
  sampler:
    name: tpe                # tpe | random | cmaes
    seed: 42

  pruner:
    name: median             # median | none
    n_warmup_steps: 5

  # ----------------------------------------------------------
  # Cross-validation / splitting
  # ----------------------------------------------------------
  validation:
    method: walk_forward     # walk_forward | holdout
    train_ratio: 0.7
    val_ratio: 0.3
    min_train_size: 252      # ~1 trading year
    step_size: 21            # monthly forward step

  # ----------------------------------------------------------
  # Early stopping (trial-level)
  # ----------------------------------------------------------
  early_stopping:
    enabled: true
    patience: 5
    min_delta: 0.0001

  # ----------------------------------------------------------
  # Hyperparameter search space
  # NOTE:
  #   These are *dynamic domains* sampled by Optuna.
  #   Static model params (like model.type) remain outside.
  # ----------------------------------------------------------
  search_space:

    model:
      lookback_window:        # Used to reshape X/y sequences in LSTM objective
        type: int
        low: 20
        high: 100
        step: 10

      hidden_size:
        type: int
        low: 32
        high: 256
        step: 32

      num_layers:
        type: int
        low: 1
        high: 3

      dropout:
        type: float
        low: 0.0
        high: 0.5

    training:
      learning_rate:
        type: float
        low: 0.0001
        high: 0.01
        log: true

      batch_size:
        type: categorical
        choices: [32, 64, 128]

      epochs:
        type: int
        low: 10
        high: 50

  # ----------------------------------------------------------
  # Reproducibility
  # ----------------------------------------------------------
  random_seed: 42
